# 9 数据库恢复技术

## 9.1 事务的基本概念

- 事务是数据库恢复和并发控制的基本单位
- 一个程序包含多个事务
- 定义语句
	- BEGIN TRANSACTION
	- COMMIT
	- ROLLBACK
	> BEGIN TRANSACTION
	> SQL语句1
	>SQL语句2
	> ...
	> COMMIT(提交) / ROLLBACK（回滚，终止，全部撤销）
	事务中的提交和回滚

- 提交（Commit）✨

	- 作用：将事务中所有操作永久保存到数据库，结束当前事务。
	- 特点：提交后的数据变更会被其他事务可见，且不可撤销。

- 回滚（Rollback）✨

	- 作用：撤销事务中所有未提交的操作，回退到事务开始前的状态，结束当前事务。
	- 特点：回滚后数据恢复原状，避免因错误操作导致数据不一致。

- 事务的ACID特性
	- 原子性
		- 逻辑工作单位
	- 一致性
		- 必须使一个状态转变为另一个状态
		- 如果数据库中只包含成功事务提交的结果，就说数据库处于一致性状态✨
	- 隔离性
		- 一个事物的执行不能被另一个事物干扰
	- 持续性（永久性）
		- 一旦提交就会发生永久的改变
		- DBMS的恢复子系统，保证了事务持久性✨
## 故障类型
- 故障的种类
	- 事务内部的故障
	- 系统故障
	- 介质故障
	- 计算机病毒
	- ....
- 系统故障
	- 特定类型的硬件错误
	- 操作系统故障
	- 数据库管理系统代码错误
	- 系统断电
	- 影响所以活跃事务
	- 缓冲区信息全部丢失
	- 不破坏数据库
	- 恢复
		- 撤销所以未完成的事务
		- 重做所以已提交的事务
		​￼- 介质故障
	- 磁盘损坏
	- 磁头碰撞
	- 瞬时强磁场干扰

￼- 恢复操作的基本原理
	- **冗余:** 利用存储在系统别处的冗余数据莱重建数据库中已破坏或不正确的那部分数据
## 9.3 恢复的实现技术
- 建立冗余数据
	- 数据转储（备份数据）
		- 静态转储与动态转储
			- 静态转储：无事物进行时
			- 动态转储：可以与事务并发进行
		- 海量转储：转储全部
		- 增量转储：转储更新过的
	- 登记日志文件
		- 格式和内容
			- 记录事务对数据库的更新操作的文件
			- 格式
				- 记录为单位
					- 事务标识
					- 操作类型
					- 操作对象
					- 旧值
					- 新值
				- 数据块为单位
					- 事务标识
					- 被更新的数据块
		- 作用
			- 进行故障恢复
		- 登记
			- 登记的次序严格按照时间次序
			- 先写日志文件，后修改数据库
## 9.4 恢复策略
- 事务故障
	- 利用日志撤销对数据库的修改
	- 由系统自动完成，不需要用户干预
- 系统故障
	- 撤销未完成的事务
	- 重做已完成的事务
	- 扫描三遍日遍日志文件
	- 由系统重新启动时自动完成，不需要用户干预
	​￼- 介质故障
	- 重装数据库
	- 重做已完成的事务
	- 
## 9.5 具有检查点的恢复技术
- 在日志文件中增加检查点记录
	- 检查点记录的内容
		- 检查点时刻所以正在执行的事务清单
		- 这些事务最近的一个日志记录的地址
- 增加重新开始文件
	- 每个检查点的地址
- 恢复子系统在登录日志文件期间动态维护日志
	- 将当前日志缓冲区的所有日志写入磁盘
	- 在日志文件写入检查点
	- 将数据缓冲区的数据记录写入磁盘的数据库
	- 将检查点记录在日志文件中的地址上写入一个重新开始文件
- 建立检查点的时间
	- 定期
		- 每隔一段时间
	- 不定期
		- 按照规则，如日志写满一半就建立
